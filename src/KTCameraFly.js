var Input = require('./KTInput');
var KTMath = require('./KTMath');
var Vector2 = require('./KTVector2');
var Vector3 = require('./KTVector3');

function FlyCamera(){
	this.__ktCamCtrls = true;
	
	this.camera = null;
	this.target = new Vector3(0.0, 0.0, 0.0);
	this.angle = new Vector2(0.0, 0.0);
	this.speed = 0.5;
}

module.exports =  FlyCamera;

FlyCamera.prototype.update = function(){
	if (this.camera.locked) return;
	
	var cam = this.camera;
	var moved = false;
	
	if (Input.isKeyDown(Input.vKey.W)){
		cam.position.x += Math.cos(this.angle.x) * this.speed;
		cam.position.y += Math.sin(this.angle.y) * this.speed;
		cam.position.z -= Math.sin(this.angle.x) * this.speed;
		
		moved = true;
	}else if (Input.isKeyDown(Input.vKey.S)){
		cam.position.x -= Math.cos(this.angle.x) * this.speed;
		cam.position.y -= Math.sin(this.angle.y) * this.speed;
		cam.position.z += Math.sin(this.angle.x) * this.speed;
		
		moved = true;
	}else if (Input.isKeyDown(Input.vKey.A)){
		cam.position.x += Math.cos(this.angle.x + KTMath.PI_2) * this.speed;
		cam.position.z -= Math.sin(this.angle.x + KTMath.PI_2) * this.speed;
		
		moved = true;
	}else if (Input.isKeyDown(Input.vKey.D)){
		cam.position.x -= Math.cos(this.angle.x + KTMath.PI_2) * this.speed;
		cam.position.z += Math.sin(this.angle.x + KTMath.PI_2) * this.speed;
		
		moved = true;
	}
	
	if (moved){
		this.setCameraPosition();
	}
};

FlyCamera.prototype.setCameraPosition = function(){
	var cam = this.camera;
	
	var x = cam.position.x + Math.cos(this.angle.x);
	var y = cam.position.y + Math.sin(this.angle.y);
	var z = cam.position.z - Math.sin(this.angle.x);
	
	this.target.set(x, y, z);
	this.camera.lookAt(this.target);
};

FlyCamera.prototype.setCamera = function(camera){
	this.camera = camera;
	
	var zoom = Vector3.vectorsDifference(camera.position, this.target).length();
	
	this.angle.x = (-KTMath.get2DAngle(this.target.x, this.target.z, camera.position.x, camera.position.z) + KTMath.PI2) % KTMath.PI2;
	this.angle.y = (-KTMath.get2DAngle(0, camera.position.y, zoom, this.target.y) + KTMath.PI2) % KTMath.PI2;
	
	this.setCameraPosition();
};
